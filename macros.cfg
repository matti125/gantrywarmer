[gcode_macro GANTRY_PREHEAT]
gcode:
    # Access parameters with defaults
    {% set temp = params.TEMP|default(200) %}
    {% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
    {% set time = params.TIME|default(300) %}
    {% set margin = params.MARGIN|default(5) %}
    {% set y_position = params.Y_POSITION|default(printer["gcode_macro RatOS"].printable_y_max|float) %}

    # Internal temperature variables
    {% set min_temp = 200 %}
    {% set max_temp = 300 %}

    # Retrieve max X and Y values
    {% set printable_x_max = printer["gcode_macro RatOS"].printable_x_max|float %}
    {% set printable_y_max = printer["gcode_macro RatOS"].printable_y_max|float %}

    # Set retraction distance from RatOS or default to 4mm
    {% set retract = printer["gcode_macro RatOS"].end_print_retract_filament|default(4)|float %}

    # Retrieve the first layer extruder temperature if specified
    {% set extruder_first_layer_temp = (params.EXTRUDER_TEMP|default("")).split(",") %}
    {% if extruder_first_layer_temp[0] %}
        {% set first_layer_temp = extruder_first_layer_temp[0]|float %}
    {% else %}
        {% set first_layer_temp = None %}
    {% endif %}

    # Save the current state of the kinematic system
    RESPOND TYPE=echo MSG="Starting GANTRY_PREHEAT: Saving current state."
    SAVE_GCODE_STATE NAME=GANTRY_PREHEAT_STATE

    # Home the printer if not already homed
    RESPOND TYPE=echo MSG="GANTRY_PREHEAT: Checking if homing is needed."
    MAYBE_HOME

    # Set the hotend temperature to the specified initial temperature
    RESPOND TYPE=echo MSG="GANTRY_PREHEAT: Setting hotend temperature to {temp}C."
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}

    # Wait for the temperature to reach at least the minimum temperature
    RESPOND TYPE=echo MSG="GANTRY_PREHEAT: Waiting for hotend temperature to reach {min_temp}C."
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}

    # Retract filament away from the hotend area
    RESPOND TYPE=echo MSG="GANTRY_PREHEAT: Retracting {retract}mm of filament."
    G91                        ; Switch to relative positioning
    G1 E-{retract} F300        ; Retract the specified amount of filament at a speed of 300 mm/min
    G90                        ; Switch back to absolute positioning

    # Calculate Y offset if Y_POSITION is beyond the printable area
    {% if y_position > printable_y_max %}
        {% set y_offset = y_position - printable_y_max %}
    {% else %}
        {% set y_offset = 0 %}
    {% endif %}

    # Apply the Y offset if necessary
    RESPOND TYPE=echo MSG="GANTRY_PREHEAT: Applying Y offset of {y_offset} mm."
    SET_GCODE_OFFSET Y={y_offset}

    # Move the head to the specified Y_POSITION (with offset if needed)
    RESPOND TYPE=echo MSG="GANTRY_PREHEAT: Moving to starting Y position: {y_position}."
    G1 X0 Y{y_position} F{speed} ; Move to the specified Y position

    # Define other parameters
    {% set move_distance = printable_x_max - (2 * margin) %} ; Total X travel distance
    {% set time_per_move = (move_distance / (speed / 60)) * 2 %} ; Time for one back-and-forth in seconds
    {% set iterations = (time / time_per_move) | int %} ; Calculate number of iterations

    RESPOND TYPE=echo MSG="GANTRY_PREHEAT: Starting back-and-forth motion for {time} seconds at {speed} mm/min."

    # Perform the back-and-forth motion for the calculated number of times
    {% for i in range(iterations) %}
        RESPOND TYPE=echo MSG="GANTRY_PREHEAT: Moving right, Iteration {i+1} of {iterations}."
        G1 X{printable_x_max - margin} Y{y_position} F{speed} ; Move to the max X position
        RESPOND TYPE=echo MSG="GANTRY_PREHEAT: Moving left, Iteration {i+1} of {iterations}."
        G1 X{margin} Y{y_position} F{speed}                  ; Move to the min X position
    {% endfor %}

    # Move to the center of the gantry before waiting for the first-layer temperature
    RESPOND TYPE=echo MSG="GANTRY_PREHEAT: Moving to the middle of the gantry."
    G1 X{printable_x_max / 2} Y{printable_y_max / 2} F{speed}

    # Set the target first-layer temperature if specified and wait until within 5 degrees
    {% if first_layer_temp %}
        RESPOND TYPE=echo MSG="GANTRY_PREHEAT: Setting first-layer temperature to {first_layer_temp}C."
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={first_layer_temp}
        RESPOND TYPE=echo MSG="GANTRY_PREHEAT: Waiting for hotend to reach first-layer temperature within Â±5C."
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={first_layer_temp - 5} MAXIMUM={first_layer_temp + 5}
    {% endif %}

    # Restore the original state of the kinematic system
    RESPOND TYPE=echo MSG="GANTRY_PREHEAT: Restoring original state."
    RESTORE_GCODE_STATE NAME=GANTRY_PREHEAT_STATE
    RESPOND TYPE=echo MSG="GANTRY_PREHEAT: Complete."